<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Admin-Panel</title>
    <link rel="stylesheet" href="../css/style.scss">
    <link rel="stylesheet" href="../css/style.css">
    <link rel="icon" type="image/x-icon" href="../icons/favicon.ico">
</head>
<body>

<nav class="navbar admin">
    <div class="content">
        <button id="backButton" class="back-btn">Zur√ºck</button>
        <div class="selection active" data-tab="fill">F√ºllst√§nde</div>
        <div class="line"></div>
        <div class="selection" data-tab="settings">Einstellungen</div>
        <button id="backButton" style="opacity: 0; pointer-events: none;" class="back-btn">Zur√ºck</button>
    </div>
</nav>

<main class="admin-wrapper">

    <!-- F√ºllst√§nde -->
    <section class="admin-tab active" id="tab-fill">
        <h2>Fl√ºssigkeitsst√§nde</h2>
        <div style="display:flex; gap:10px; align-items:center; margin-bottom:10px;">
            <button id="sortToggle" class="sort-btn">üîΩ Sortierung: Absteigend</button>
            <button id="refillAllBtn" class="save-btn">üîÑ Alle auff√ºllen</button>
        </div>
        <div class="liquid-list" id="liquidList"></div>
    </section>

    <!-- Einstellungen -->
    <section class="admin-tab" id="tab-settings">
        <h2>PIN-Einstellungen</h2>
        <div class="pin-settings">
            <label for="oldAlcoholPin">Alter Alkohol-PIN:</label>
            <input type="password" id="oldAlcoholPin" maxlength="4" placeholder="****">

            <label for="newAlcoholPin">Neuer Alkohol-PIN:</label>
            <input type="password" id="newAlcoholPin" maxlength="4" placeholder="****">

            <button id="savePinBtn" class="save-btn">Speichern</button>
        </div>
        <p id="pinStatus" class="status-msg"></p>
    </section>

    <button id="flushButton" class="flush-btn">üíß Alle Pumpen sp√ºlen</button>
</main>

<script>
    // Tab-Navigation
    document.querySelectorAll(".selection").forEach(sel => {
        sel.addEventListener("click", () => {
            document.querySelectorAll(".selection").forEach(s => s.classList.remove("active"));
            sel.classList.add("active");
            document.querySelectorAll(".admin-tab").forEach(tab => tab.classList.remove("active"));
            document.getElementById("tab-" + sel.dataset.tab).classList.add("active");
        });
    });

    // Globale Variablen
    const list = document.getElementById("liquidList");
    const sortBtn = document.getElementById("sortToggle");
    const refillAllBtn = document.getElementById("refillAllBtn");
    let ascending = false;
    let ingredients = [];

    // Zutaten aus Backend laden
    async function loadIngredients() {
        try {
            const res = await fetch("http://127.0.0.1:5000/api/ingredients");
            if (!res.ok) throw new Error("Fehler beim Abrufen der Zutaten");
            ingredients = await res.json();
            renderIngredients();
        } catch (err) {
            console.error(err);
            list.innerHTML = `<p style="color:#ff6666;text-align:center;">Fehler beim Laden der Zutaten.</p>`;
        }
    }

    // Zutatenliste rendern
    function renderIngredients() {
        list.innerHTML = "";
        const normalized = ingredients.map(i => ({
            id: i.ingredient_id ?? i.id ?? 0,
            name: i.ingredient_name ?? i.name ?? "Unbekannt",
            current: i.current_level ?? i.level_ml ?? 0,
            max: i.max_level ?? i.max_level_ml ?? 2000
        }));

        const sorted = [...normalized].sort((a, b) =>
            ascending ? a.current - b.current : b.current - a.current
        );

        sorted.forEach(i => {
            const percent = Math.min(100, Math.round((i.current / i.max) * 100));
            const el = document.createElement("div");
            el.classList.add("liquid-item");
            el.innerHTML = `
                <span class="liquid-name">${i.name}</span>
                <div class="liquid-bar">
                    <div class="fill" style="width:${percent}%;"></div>
                </div>
                <span class="liquid-percent">${percent}%</span>
                <div style="display: flex; gap: 16px; margin-top: 12px;">
                    <button class="refill-btn" data-id="${i.id}">‚ûï Nachf√ºllen</button>
                    <button class="set-btn" data-id="${i.id}">‚úèÔ∏è Setzen</button>
                </div>
            `;
            list.appendChild(el);
        });

        // Buttons f√ºr Nachf√ºllen und Setzen aktivieren
        list.querySelectorAll(".refill-btn").forEach(btn => {
            btn.addEventListener("click", () => refillIngredient(parseInt(btn.dataset.id)));
        });
        list.querySelectorAll(".set-btn").forEach(btn => {
            btn.addEventListener("click", () => setIngredientLevel(parseInt(btn.dataset.id)));
        });

        sortBtn.textContent = ascending
            ? "üîº Sortierung: Aufsteigend"
            : "üîΩ Sortierung: Absteigend";
    }

    // Nachf√ºllen einzelner Zutat
    async function refillIngredient(id) {
        const amount = prompt("Wie viel ml hinzuf√ºgen?");
        if (!amount || isNaN(amount) || amount <= 0) return alert("Ung√ºltige Menge.");
        try {
            const res = await fetch("http://127.0.0.1:5000/api/ingredients/refill", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ingredient_id: id, amount: parseFloat(amount) })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Fehler beim Nachf√ºllen");
            alert(`Zutat #${id} um ${amount}ml aufgef√ºllt.`);
            await loadIngredients();
        } catch (err) {
            console.error(err);
            alert("Fehler beim Nachf√ºllen.");
        }
    }

    // Setzen eines festen Levels
    async function setIngredientLevel(id) {
        const level = prompt("Neuen F√ºllstand in ml eingeben:");
        if (!level || isNaN(level) || level < 0) return alert("Ung√ºltiger Wert.");
        try {
            const res = await fetch("http://127.0.0.1:5000/api/ingredients/set", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ ingredient_id: id, level: parseFloat(level) })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Fehler beim Setzen des Levels");
            alert(`Zutat #${id} auf ${level}ml gesetzt.`);
            await loadIngredients();
        } catch (err) {
            console.error(err);
            alert("Fehler beim Setzen des Levels.");
        }
    }

    // Sortierung umschalten
    sortBtn.addEventListener("click", () => {
        ascending = !ascending;
        renderIngredients();
    });

    // Alle Zutaten auff√ºllen
    refillAllBtn.addEventListener("click", async () => {
        if (!confirm("Alle Zutaten auf 2000 ml auff√ºllen?")) return;
        try {
            const res = await fetch("http://127.0.0.1:5000/api/ingredients/refill_all", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ level: 2000 })
            });
            const data = await res.json();
            if (!res.ok) throw new Error(data.error || "Fehler beim Auff√ºllen");
            alert("Alle Zutaten wurden aufgef√ºllt!");
            ingredients = data.ingredients_status || [];
            renderIngredients();
        } catch (err) {
            console.error(err);
            alert("Fehler beim Auff√ºllen der Zutaten.");
        }
    });

    // Flush-Button (Backend-Endpoint noch hinzuf√ºgen)
    document.getElementById("flushButton").addEventListener("click", async () => {
        alert("Alle Pumpen werden gesp√ºlt... (Backend-Endpoint fehlt noch)");
    });

    // PIN √§ndern
    document.getElementById("savePinBtn").addEventListener("click", async () => {
        const oldPinEl = document.getElementById("oldAlcoholPin");
        const newPinEl = document.getElementById("newAlcoholPin");
        const status = document.getElementById("pinStatus");

        const oldPin = (oldPinEl?.value || "").trim();
        const newPin = (newPinEl?.value || "").trim();

        if (oldPin.length !== 4 || isNaN(oldPin) || newPin.length !== 4 || isNaN(newPin)) {
            status.textContent = "Bitte alte und neue 4-stellige numerische PINs eingeben.";
            status.style.color = "#ff6666";
            return;
        }

        try {
            const response = await fetch("http://127.0.0.1:5000/api/change-pin", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ old_pin: oldPin, new_pin: newPin })
            });
            const result = await response.json();

            if (!response.ok) {
                status.textContent = result.message || "Fehler beim √Ñndern des PINs.";
                status.style.color = "#ff6666";
                return;
            }

            status.textContent = "Neuer Alkohol-PIN gespeichert!";
            status.style.color = "#a678ff";
            oldPinEl.value = "";
            newPinEl.value = "";
        } catch (error) {
            status.textContent = "Verbindungsfehler zum Server.";
            status.style.color = "#ff6666";
        }
    });

    // Zur√ºck zur Hauptseite
    document.getElementById("backButton").addEventListener("click", () => {
        window.location.href = "index.html";
    });

    // Initiales Laden
    loadIngredients();
</script>
</body>
</html>
